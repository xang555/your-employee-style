---
const url = new URL(Astro.url);
const path = url.pathname;
const searchParams = url.searchParams;

const supportedLocales = ['th', 'en'];
const defaultLocale = 'th' as const;

let locale = searchParams.get('lang') as Locale || defaultLocale;
if (!supportedLocales.includes(locale)) {
  locale = defaultLocale;
}

if (!searchParams.get('lang')) {
  const cookieLocale = Astro.cookies.get('locale')?.value as Locale;
  if (cookieLocale && supportedLocales.includes(cookieLocale)) {
    locale = cookieLocale;
  }
}

Astro.cookies.set('locale', locale, {
  path: '/',
  maxAge: 60 * 60 * 24 * 365,
});

Astro.locals.locale = locale;
Astro.locals.t = (key: string) => {
  const translations = await import('../lib/translations');
  return translations.t(locale, key);
};
---
