---
import Layout from '../../layouts/Layout.astro';
import db, { type User, type Result, getUserByToken } from '../../lib/db';
import { getStyleIconSVG, getStyleIconColor, getStyleIconName } from '../../lib/icons';
import { getTranslations, type Locale } from '../../lib/translations';

const locale = (Astro.cookies.get('locale')?.value || 'th') as 'th' | 'en';
const trans = getTranslations(locale);

function t(key: string): string {
  const keys = key.split('.');
  let value: any = trans;
  for (const k of keys) {
    value = value[k];
    if (value === undefined) return key;
  }
  return value as string;
}

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/');
}

// Validate token format (should be 32 character hex string)
const tokenRegex = /^[a-f0-9]{32}$/i;
if (!tokenRegex.test(id)) {
  return Astro.redirect('/');
}

// Look up user by access token instead of sequential ID
const userRow = await getUserByToken(id);

if (!userRow) {
  return Astro.redirect('/');
}

const resultStmt = db.prepare('SELECT * FROM results WHERE id = ?');
const resultRow = await resultStmt.get(userRow.result_id) as Result | undefined;

if (!resultRow) {
  return Astro.redirect('/');
}

const result = resultRow;
const styleId = userRow.result_id;
const styleIcon = getStyleIconSVG(styleId);
const styleIconColor = getStyleIconColor(styleId);
const styleTrans = trans.styles[styleId as keyof typeof trans.styles];

const styleName = getStyleIconName(styleId, locale);
const styleDefinition = styleTrans?.definition || result.definition;
const styleStrengths = styleTrans?.strengths || result.strengths;
const styleHrAdvice = styleTrans?.hrAdvice || result.hr_advice;

const iAmText = locale === 'th' ? `ฉันเป็น ${styleName}! คุณเป็นแบบไหน?` : `I am a ${styleName}! What are you?`;
const takeAssessmentText = locale === 'th'
  ? `${styleDefinition} ทำแบประเมินเพื่อค้นพบสไตล์การทำงานของคุณ`
  : `${styleDefinition} Take the Employee Style Assessment to discover your professional DNA.`;
const ogTitle = iAmText;
const ogDescription = takeAssessmentText;

// Use default OG image - poster generation disabled for Cloudflare Pages
const posterImageUrl = userRow.poster_image || '/og-default.png';

// Construct absolute URL for Open Graph image (social media crawlers need full URLs)
const ogImage = new URL(posterImageUrl, Astro.url).href;

const shareUrl = Astro.url.toString();
const shareText = locale === 'th'
  ? `ฉันเป็น ${styleName}! ทำแบบประเมินเพื่อค้นพบสไตล์การทำงานของคุณ`
  : `I am a ${styleName}! Take the Employee Style Assessment to discover your professional DNA.`;