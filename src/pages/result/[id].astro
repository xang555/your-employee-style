---
import Layout from '../../layouts/Layout.astro';
import db, { type User, type Result, getUserByToken, generateAccessToken, updateUserPosterImage } from '../../lib/db';
import { createCanvas, loadImage } from 'canvas';
import { promises as fs } from 'fs';
import path from 'path';
import { getStyleIconSVG, getStyleIconColor, getStyleIconName } from '../../lib/icons';
import { getTranslations, type Locale } from '../../lib/translations';

const locale = (Astro.cookies.get('locale')?.value || 'th') as 'th' | 'en';
const trans = getTranslations(locale);

function t(key: string): string {
  const keys = key.split('.');
  let value: any = trans;
  for (const k of keys) {
    value = value[k];
    if (value === undefined) return key;
  }
  return value as string;
}

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/');
}

// Validate token format (should be 32 character hex string)
const tokenRegex = /^[a-f0-9]{32}$/i;
if (!tokenRegex.test(id)) {
  return Astro.redirect('/');
}

// Look up user by access token instead of sequential ID
const userRow = getUserByToken(id);

if (!userRow) {
  return Astro.redirect('/');
}

const resultStmt = db.prepare('SELECT * FROM results WHERE id = ?');
const resultRow = resultStmt.get(userRow.result_id) as Result | undefined;

if (!resultRow) {
  return Astro.redirect('/');
}

const result = resultRow;
const styleId = userRow.result_id;
const styleIcon = getStyleIconSVG(styleId);
const styleIconColor = getStyleIconColor(styleId);
const styleTrans = trans.styles[styleId as keyof typeof trans.styles];

const styleName = getStyleIconName(styleId, locale);
const styleDefinition = styleTrans?.definition || result.definition;
const styleStrengths = styleTrans?.strengths || result.strengths;
const styleHrAdvice = styleTrans?.hrAdvice || result.hr_advice;

const iAmText = locale === 'th' ? `ฉันเป็น ${styleName}! คุณเป็นแบบไหน?` : `I am a ${styleName}! What are you?`;
const takeAssessmentText = locale === 'th'
  ? `${styleDefinition} ทำแบประเมินเพื่อค้นพบสไตล์การทำงานของคุณ`
  : `${styleDefinition} Take the Employee Style Assessment to discover your professional DNA.`;
const ogTitle = iAmText;
const ogDescription = takeAssessmentText;

// Generate poster image if it doesn't exist
let posterImageUrl = userRow.poster_image;
const POSTERS_DIR = path.join(process.cwd(), 'public', 'posters');

if (!posterImageUrl) {
  // Ensure directory exists
  try {
    await fs.mkdir(POSTERS_DIR, { recursive: true });
  } catch (err) {
    // Directory exists or error
  }

  const POSTER_WIDTH = 1200;
  const POSTER_HEIGHT = 630;
  const filename = `poster-${id}.png`;
  const filePath = path.join(POSTERS_DIR, filename);

  // Create canvas
  const canvas = createCanvas(POSTER_WIDTH, POSTER_HEIGHT);
  const ctx = canvas.getContext('2d');

  // Color map
  const colorMap: Record<number, string> = {
    1: '#3B82F6', 2: '#22C55E', 3: '#EAB308', 4: '#A855F7',
    5: '#10B981', 6: '#F97316', 7: '#EC4899', 8: '#06B6D4', 9: '#F43F5E'
  };
  const primaryColor = colorMap[styleId] || '#3B82F6';

  // Draw gradient background
  const gradient = ctx.createLinearGradient(0, 0, POSTER_WIDTH, POSTER_HEIGHT);
  gradient.addColorStop(0, primaryColor);
  gradient.addColorStop(1, '#8B5CF6');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, POSTER_WIDTH, POSTER_HEIGHT);

  // Add dot pattern
  ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
  for (let x = 0; x < POSTER_WIDTH; x += 30) {
    for (let y = 0; y < POSTER_HEIGHT; y += 30) {
      ctx.beginPath();
      ctx.arc(x, y, 2, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  // Draw white card
  const cardPadding = 60;
  const cardX = cardPadding;
  const cardY = cardPadding;
  const cardWidth = POSTER_WIDTH - (cardPadding * 2);
  const cardHeight = POSTER_HEIGHT - (cardPadding * 2);
  const cardRadius = 20;

  ctx.fillStyle = 'white';
  ctx.beginPath();
  ctx.roundRect(cardX, cardY, cardWidth, cardHeight, cardRadius);
  ctx.fill();

  // Draw icon circle
  const iconCircleSize = 120;
  const iconX = (POSTER_WIDTH - iconCircleSize) / 2;
  const iconY = 120;

  ctx.fillStyle = primaryColor;
  ctx.beginPath();
  ctx.arc(POSTER_WIDTH / 2, iconY + (iconCircleSize / 2), iconCircleSize / 2, 0, Math.PI * 2);
  ctx.fill();

  // Draw simple icon (circle for now)
  ctx.fillStyle = 'white';
  ctx.beginPath();
  ctx.arc(POSTER_WIDTH / 2, iconY + (iconCircleSize / 2), 40, 0, Math.PI * 2);
  ctx.fill();

  // Style name
  ctx.fillStyle = '#1F2937';
  ctx.font = 'bold 56px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText(styleName, POSTER_WIDTH / 2, 320);

  // Subtitle
  const subtitle = locale === 'th' ? 'ค้นพบสไตล์การทำงานของคุณ' : 'Discover Your Work Style';
  ctx.fillStyle = '#6B7280';
  ctx.font = '32px sans-serif';
  ctx.fillText(subtitle, POSTER_WIDTH / 2, 380);

  // CTA text
  const ctaText = locale === 'th'
    ? 'ทำแบบประเมินเพื่อค้นพบสไตล์ของคุณ'
    : 'Take the assessment to discover your style';
  ctx.fillStyle = '#9CA3AF';
  ctx.font = '24px sans-serif';
  ctx.fillText(ctaText, POSTER_WIDTH / 2, 430);

  // Branding
  const brandText = locale === 'th' ? 'Your Employee Style' : 'Your Employee Style';
  ctx.fillStyle = primaryColor;
  ctx.font = 'bold 28px sans-serif';
  ctx.fillText(brandText, POSTER_WIDTH / 2, 530);

  // Save canvas
  const buffer = canvas.toBuffer('image/png');
  await fs.writeFile(filePath, buffer);

  posterImageUrl = `/posters/${filename}`;

  // Update database
  updateUserPosterImage(userRow.id, posterImageUrl);
}

// Construct absolute URL for Open Graph image (social media crawlers need full URLs)
const ogImage = new URL(posterImageUrl, Astro.url).href;

const shareUrl = Astro.url.toString();
const shareText = locale === 'th'
  ? `ฉันเป็น ${styleName}! ทำแบบประเมินเพื่อค้นพบสไตล์การทำงานของคุณ`
  : `I am a ${styleName}! Take the Employee Style Assessment to discover your professional DNA.`;
---

<Layout title={`Your Result: ${styleName}`} description={ogDescription} ogImage={ogImage}>
  <main class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-12 px-4">
    <div class="max-w-4xl mx-auto">
      <!-- Success Header -->
      <div class="text-center mb-10">
        <div class={`inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-primary-600 to-purple-600 rounded-full mb-6 shadow-lg ${styleIconColor}`}>
          <div set:html={styleIcon} class="w-10 h-10" />
        </div>
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
          {t('result.title')}
        </h1>
        <p class="text-xl text-gray-600">
          {userRow.name}, {locale === 'th' ? 'นี่คือดีเอ็นของคุณในการทำงาน' : "here's your professional DNA"}
        </p>
      </div>

      <!-- Result Card -->
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-8">
        <!-- Header with gradient -->
        <div class="bg-gradient-to-r from-primary-600 to-purple-600 p-8 text-white">
          <span class="text-sm font-medium uppercase tracking-wider opacity-90">{t('result.yourStyle')}</span>
          <h2 class="text-3xl md:text-4xl font-bold mt-2">{styleName}</h2>
        </div>

        <!-- Content -->
        <div class="p-8">
          <!-- Definition -->
          <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
              <svg class="w-5 h-5 mr-2 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              {t('result.about')}
            </h3>
            <p class="text-gray-700 leading-relaxed">{styleDefinition}</p>
          </div>

          <!-- Strengths -->
          <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
              <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              {t('result.strengths')}
            </h3>
            <p class="text-gray-700 leading-relaxed">{styleStrengths}</p>
          </div>

          <!-- HR Advice -->
          <div class="bg-blue-50 rounded-xl p-6 border-l-4 border-primary-600">
            <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
              <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
              </svg>
              {t('result.hrAdvice')}
            </h3>
            <p class="text-gray-700 leading-relaxed">{styleHrAdvice}</p>
          </div>
        </div>
      </div>

      <!-- Social Sharing -->
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
        <h3 class="text-xl font-bold text-gray-900 mb-4 text-center">{t('result.share')}</h3>
        <p class="text-gray-600 text-center mb-6">
          {t('result.shareSubtitle')}
        </p>
        <div class="flex flex-wrap justify-center gap-4">
          <!-- X (Twitter) -->
          <a
            href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center px-6 py-3 bg-black text-white font-semibold rounded-full hover:bg-gray-800 transition-all hover:scale-105 shadow-md"
          >
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
            {t('result.shareX')}
          </a>

          <!-- Facebook -->
          <a
            href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-full hover:bg-blue-700 transition-all hover:scale-105 shadow-md"
          >
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
            {t('result.shareFacebook')}
          </a>

          <!-- WhatsApp -->
          <a
            href={`https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center px-6 py-3 bg-green-500 text-white font-semibold rounded-full hover:bg-green-600 transition-all hover:scale-105 shadow-md"
          >
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91 0-2.65-1.03-5.14-2.9-7.01C17.18 3.03 14.69 2 12.04 2z"/>
            </svg>
            {t('result.shareWhatsApp')}
          </a>

          <!-- Telegram -->
          <a
            href={`https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center px-6 py-3 bg-blue-500 text-white font-semibold rounded-full hover:bg-blue-600 transition-all hover:scale-105 shadow-md"
          >
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
            {t('result.shareTelegram')}
          </a>
        </div>
      </div>

      <!-- Call to Action -->
      <div class="text-center bg-white rounded-2xl shadow-xl p-8">
        <h3 class="text-2xl font-bold text-gray-900 mb-4">{t('result.knowSomeone')}</h3>
        <p class="text-gray-600 mb-6">
          {t('result.shareWithTeam')}
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a
            href="/"
            class="inline-flex items-center justify-center px-8 py-4 bg-primary-600 text-white font-semibold rounded-full hover:bg-primary-700 transition-all shadow-md hover:shadow-lg"
          >
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            {t('result.retakeAssessment')}
          </a>
          <button
            id="copy-link-btn"
            class="inline-flex items-center justify-center px-8 py-4 bg-gray-100 text-gray-700 font-semibold rounded-full hover:bg-gray-200 transition-all"
          >
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
            </svg>
            {t('result.copyLink')}
          </button>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script define:vars={{ locale, t: trans }}>
  const copyLinkBtn = document.getElementById('copy-link-btn');

  function getT(key) {
    const keys = key.split('.');
    let value = t;
    for (const k of keys) {
      value = value[k];
      if (value === undefined) return key;
    }
    return value;
  }

  // Copy link functionality
  if (copyLinkBtn) {
    copyLinkBtn.addEventListener('click', async () => {
      const shareUrl = window.location.href;
      try {
        await navigator.clipboard.writeText(shareUrl);
        copyLinkBtn.textContent = getT('result.copied');
        setTimeout(() => {
          copyLinkBtn.innerHTML = `
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
            </svg>
            ${getT('result.copyLink')}
          `;
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
        alert(getT('result.copyFailed'));
      }
    });
  }
</script>
