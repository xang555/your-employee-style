---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getTranslations, type Locale } from '../../lib/translations';

const username = Astro.locals.admin?.username || 'Admin';
const locale = (Astro.cookies.get('locale')?.value || 'th') as 'th' | 'en';
const trans = getTranslations(locale);

function t(key: string): string {
  const keys = key.split('.');
  let value: any = trans;
  for (const k of keys) {
    value = value[k];
    if (value === undefined) return key;
  }
  return value as string;
}
---

<AdminLayout title={t('admin.reports')} activeTab="reports" username={username}>
  <div class="p-8">
    <div class="flex items-center justify-between mb-8">
      <h1 class="text-3xl font-bold text-gray-900">{t('admin.assessmentReports')}</h1>
      <div class="flex items-center gap-3">
        <button
          id="export-csv-btn"
          class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center"
        >
          <svg
            class="w-5 h-5 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            />
          </svg>
          {t('admin.exportCSV')}
        </button>
        <button
          id="refresh-btn"
          class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center"
        >
          <svg
            class="w-5 h-5 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            />
          </svg>
          {t('common.refresh')}
        </button>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-md overflow-hidden" data-translations={JSON.stringify(trans)}>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-4 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-16">
                {t('admin.style')}
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                {t('admin.tableName')}
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                {t('admin.tableEmail')}
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                {t('admin.tableResult')}
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                {t('admin.tableDate')}
              </th>
              <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                {t('admin.tableAction')}
              </th>
            </tr>
          </thead>
          <tbody id="reports-table-body" class="divide-y divide-gray-200">
            <tr>
              <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                <div class="flex justify-center items-center">
                  <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
                  <span class="ml-3">{t('admin.loadingReports')}</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="empty-state" class="hidden p-12 text-center">
        <svg
          class="mx-auto h-12 w-12 text-gray-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">{t('admin.noAssessments')}</h3>
        <p class="mt-1 text-sm text-gray-500">
          {t('admin.noAssessmentsDesc')}
        </p>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  let reports: any[] = [];

  // Parse translations from data attribute
  const translations = JSON.parse(document.querySelector('[data-translations]')?.getAttribute('data-translations') || '{}');

  function getT(key) {
    const keys = key.split('.');
    let value = translations;
    for (const k of keys) {
      value = value[k];
      if (value === undefined) return key;
    }
    return value;
  }

  function getStyleName(resultId: number): string {
    const styleTrans = translations.styles[resultId];
    return styleTrans?.name || '';
  }

  async function loadReports() {
    const token = localStorage.getItem('adminToken');
    const tableBody = document.getElementById('reports-table-body');
    const emptyState = document.getElementById('empty-state');

    try {
      const response = await fetch('/admin/api/reports', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      const result = await response.json();

      if (result.success && result.data) {
        reports = result.data;
        renderReports();
      }
    } catch (error) {
      console.error('Error loading reports:', error);
      if (tableBody) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-12 text-center text-red-500">
              ${getT('admin.failedLoadReports')}
            </td>
          </tr>
        `;
      }
    }
  }

  function renderReports() {
    const tableBody = document.getElementById('reports-table-body');
    const emptyState = document.getElementById('empty-state');

    if (!tableBody) return;

    if (reports.length === 0) {
      tableBody.innerHTML = '';
      emptyState?.classList.remove('hidden');
      return;
    }

    emptyState?.classList.add('hidden');

    const iconMap: Record<number, string> = {
      1: '<svg class="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v8" /><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h8" /></svg>',
      2: '<svg class="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="3" /><path d="M12 16v5" /><path d="M12 9V4" /><path d="M4 12h5" /><path d="M15 12h5" /><circle cx="7" cy="7" r="2" /><circle cx="17" cy="7" r="2" /><circle cx="7" cy="17" r="2" /><circle cx="17" cy="17" r="2" /><path d="M12 5l-2 2" /><path d="M12 19l-2-2" /><path d="M12 19l2-2" /></svg>',
      3: '<svg class="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /><circle cx="12" cy="13" r="2" /></svg>',
      4: '<svg class="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 3L12 3" /><path d="M12 3C9 3 7 5 7 8" /><path d="M12 3C15 3 17 5 17 8" /><path d="M7 8v6" /><path d="M17 8v6" /><path d="M12 8v6" /><circle cx="12" cy="15" r="3" /><path d="M12 18v4" /><path d="M8 22h8" /></svg>',
      5: '<svg class="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="9" /><path d="M15 8h.01" /><path d="M16 11l-2 2 3 3" /><path d="M11 13h.01" /><path d="M12 13h.01" /><path d="M12 13h.01" /></svg>',
      6: '<svg class="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="7" height="7" rx="1" /><rect x="14" y="3" width="7" height="7" rx="1" /><rect x="14" y="14" width="7" height="7" rx="1" /><rect x="3" y="14" width="7" height="7" rx="1" /><circle cx="12" cy="12" r="2" /></svg>',
      7: '<svg class="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 18h6" /><path d="M10 22h4" /><path d="M12 2a6 6 0 0 0-6 6v5.25a6 6 0 0 0 3.5 5.25" /><path d="M12 2a6 6 0 0 1 6 6v5.25a6 6 0 0 1-3.5 5.25" /><circle cx="12" cy="8" r="2" /></svg>',
      8: '<svg class="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="3" /><path d="M12 2v2" /><path d="M12 20v2" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="M4.93 4.93l1.41 1.41" /><path d="M17.66 17.66l1.41 1.41" /><path d="M4.93 19.07l1.41-1.41" /><path d="M17.66 6.34l1.41-1.41" /><circle cx="12" cy="12" r="7" stroke-dasharray="2 2" /></svg>',
      9: '<svg class="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="8" r="4" /><path d="M12 12v8" /><path d="M12 20H8" /><path d="M12 20h4" /><path d="M16 6l2-2" /><path d="M8 6l-2-2" /><circle cx="15" cy="9" r="0.5" fill="currentColor" /><circle cx="9" cy="9" r="0.5" fill="currentColor" /><path d="M10 10q1-1 2 0" stroke-linecap="round" /></svg>'
    };

    const colorMap: Record<number, string> = {
      1: 'bg-blue-100 text-blue-600',
      2: 'bg-green-100 text-green-600',
      3: 'bg-yellow-100 text-yellow-600',
      4: 'bg-purple-100 text-purple-600',
      5: 'bg-emerald-100 text-emerald-600',
      6: 'bg-orange-100 text-orange-600',
      7: 'bg-pink-100 text-pink-600',
      8: 'bg-cyan-100 text-cyan-600',
      9: 'bg-rose-100 text-rose-600'
    };

    tableBody.innerHTML = reports.map((report: any) => `
      <tr class="hover:bg-gray-50 transition-colors">
        <td class="px-4 py-4 whitespace-nowrap">
          <div class="w-10 h-10 rounded-full ${colorMap[report.result_id as keyof typeof colorMap] || 'bg-gray-100 text-gray-600'} flex items-center justify-center">
            ${iconMap[report.result_id as keyof typeof iconMap] || '<svg class="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="3" /></svg>'}
          </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="text-sm font-medium text-gray-900">${report.name}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="text-sm text-gray-600">${report.email}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
            ${getStyleName(report.result_id)}
          </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
          ${new Date(report.created_at).toLocaleString()}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
          <a
            href="/result/${report.access_token}"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors"
            title="${getT('admin.viewResult')}"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
            ${getT('admin.viewResult')}
          </a>
        </td>
      </tr>
    `).join('');
  }

  document.getElementById('refresh-btn')?.addEventListener('click', loadReports);

  // Export CSV functionality
  function exportToCSV() {
    if (reports.length === 0) {
      alert(getT('admin.noAssessments'));
      return;
    }

    // Get headers
    const headers = [getT('admin.tableName'), getT('admin.tableEmail'), getT('admin.tableResult'), getT('admin.tableDate')];

    // Build CSV content
    let csvContent = headers.join(',') + '\n';

    reports.forEach((report: any) => {
      const row = [
        `"${report.name}"`,
        `"${report.email}"`,
        `"${getStyleName(report.result_id)}"`,
        `"${new Date(report.created_at).toLocaleString()}"`
      ];
      csvContent += row.join(',') + '\n';
    });

    // Create download link
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);

    link.setAttribute('href', url);
    link.setAttribute('download', `employee-style-reports-${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Show success message
    alert(getT('admin.exportCSVSuccess'));
  }

  document.getElementById('export-csv-btn')?.addEventListener('click', exportToCSV);

  loadReports();
</script>
