---
import Layout from '../layouts/Layout.astro';
import { questions } from '../lib/questions';
---

<Layout title="Assessment - Employee Style">
  <main class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-8 px-4">
    <div class="max-w-3xl mx-auto">
      <!-- Progress Bar -->
      <div class="mb-8">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-700">Question <span id="current-question">1</span> of 10</span>
          <span class="text-sm font-medium text-primary-600" id="progress-percent">10%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div id="progress-bar" class="bg-primary-600 h-2.5 rounded-full transition-all duration-300" style="width: 10%"></div>
        </div>
      </div>

      <!-- Quiz Card -->
      <div class="bg-white rounded-2xl shadow-xl p-8 md:p-10">
        <div id="quiz-container">
          <!-- Question will be rendered here by JavaScript -->
        </div>
      </div>

      <!-- Navigation -->
      <div class="flex justify-between mt-6">
        <button
          id="back-btn"
          class="px-6 py-3 text-gray-700 font-medium rounded-lg hover:bg-gray-100 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          ← Back
        </button>
        <button
          id="next-btn"
          class="px-6 py-3 bg-primary-600 text-white font-semibold rounded-lg hover:bg-primary-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          Next →
        </button>
      </div>
    </div>
  </main>
</Layout>

<script define:vars={{ questions }}>
  const userName = sessionStorage.getItem('userName');
  const userEmail = sessionStorage.getItem('userEmail');
  
  if (!userName || !userEmail) {
    window.location.href = '/onboarding';
  }

  let currentQuestionIndex = 0;
  const answers = new Array(10).fill(null);

  const quizContainer = document.getElementById('quiz-container');
  const progressBar = document.getElementById('progress-bar');
  const currentQuestionSpan = document.getElementById('current-question');
  const progressPercent = document.getElementById('progress-percent');
  const backBtn = document.getElementById('back-btn');
  const nextBtn = document.getElementById('next-btn');

  function renderQuestion() {
    const question = questions[currentQuestionIndex];
    
    const answersHtml = question.answers.map((answer) => {
      const checked = answers[currentQuestionIndex] === answer.categoryId ? 'checked' : '';
      return `
        <label class="block cursor-pointer">
          <input
            type="radio"
            name="question-${question.id}"
            value="${answer.categoryId}"
            class="hidden peer"
            ${checked}
          />
          <div class="p-5 border-2 border-gray-200 rounded-xl peer-checked:border-primary-600 peer-checked:bg-primary-50 hover:border-primary-300 transition-all">
            <span class="text-gray-900 font-medium">${answer.text}</span>
          </div>
        </label>
      `;
    }).join('');

    quizContainer.innerHTML = `
      <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-8">${question.text}</h2>
      <div class="space-y-4">
        ${answersHtml}
      </div>
    `;

    const radios = quizContainer.querySelectorAll('input[type="radio"]');
    radios.forEach((radio) => {
      radio.addEventListener('change', (e) => {
        const target = e.target;
        answers[currentQuestionIndex] = parseInt(target.value);
        nextBtn.disabled = false;
      });
    });

    const progress = ((currentQuestionIndex + 1) / 10) * 100;
    progressBar.style.width = `${progress}%`;
    currentQuestionSpan.textContent = (currentQuestionIndex + 1).toString();
    progressPercent.textContent = `${progress}%`;

    backBtn.disabled = currentQuestionIndex === 0;
    nextBtn.disabled = answers[currentQuestionIndex] === null;
    nextBtn.textContent = currentQuestionIndex === 9 ? 'Submit' : 'Next →';
  }

  backBtn.addEventListener('click', () => {
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      renderQuestion();
    }
  });

  nextBtn.addEventListener('click', async () => {
    if (currentQuestionIndex < 9) {
      currentQuestionIndex++;
      renderQuestion();
    } else {
      await submitQuiz();
    }
  });

  async function submitQuiz() {
    nextBtn.disabled = true;
    nextBtn.textContent = 'Submitting...';

    try {
      const response = await fetch('/api/submit', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: userName,
          email: userEmail,
          answers: answers,
        }),
      });

      const data = await response.json();

      if (response.ok) {
        sessionStorage.clear();
        window.location.href = `/result/${data.userId}`;
      } else {
        alert('Error submitting quiz: ' + data.error);
        nextBtn.disabled = false;
        nextBtn.textContent = 'Submit';
      }
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred. Please try again.');
      nextBtn.disabled = false;
      nextBtn.textContent = 'Submit';
    }
  }

  renderQuestion();
</script>
