---
import Layout from '../layouts/Layout.astro';
import { questions, TOTAL_QUESTIONS } from '../lib/questions';
import { getTranslations, type Locale } from '../lib/translations';

const locale = (Astro.cookies.get('locale')?.value || 'th') as Locale;
const trans = getTranslations(locale);

function t(key: string): string {
  const keys = key.split('.');
  let value: any = trans;
  for (const k of keys) {
    value = value[k];
    if (value === undefined) return key;
  }
  return value as string;
}
---

<Layout title={`${t('quiz.title')} - ${t('quiz.subtitle')}`}>
  <main class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-8 px-4">
    <div class="max-w-3xl mx-auto">
      <!-- Progress Bar -->
      <div class="mb-8">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-700">{t('quiz.questionOf')} <span id="current-question">1</span> {t('common.of')} {TOTAL_QUESTIONS}</span>
          <span class="text-sm font-medium text-primary-600" id="progress-percent">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div id="progress-bar" class="bg-primary-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>

      <!-- Quiz Card -->
      <div class="bg-white rounded-2xl shadow-xl p-8 md:p-10">
        <div id="quiz-container">
          <!-- Question will be rendered here by JavaScript -->
        </div>
      </div>

      <!-- Navigation -->
      <div class="flex justify-between mt-6">
        <button
          id="back-btn"
          class="px-6 py-3 text-gray-700 font-medium rounded-lg hover:bg-gray-100 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          ‚Üê {t('quiz.back')}
        </button>
        <button
          id="next-btn"
          class="px-6 py-3 bg-primary-600 text-white font-semibold rounded-lg hover:bg-primary-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          {t('quiz.next')}
        </button>
      </div>
    </div>
  </main>
</Layout>

<script define:vars={{ questions, trans, locale }}>
  const userName = sessionStorage.getItem('userName');
  const userEmail = sessionStorage.getItem('userEmail');

  if (!userName || !userEmail) {
    window.location.href = '/onboarding';
  }

  const totalQuestions = questions.length;
  let currentQuestionIndex = 0;
  const answers = new Array(totalQuestions).fill(null);

  const quizContainer = document.getElementById('quiz-container');
  const progressBar = document.getElementById('progress-bar');
  const currentQuestionSpan = document.getElementById('current-question');
  const progressPercent = document.getElementById('progress-percent');
  const backBtn = document.getElementById('back-btn');
  const nextBtn = document.getElementById('next-btn');

  function getT(key) {
    const keys = key.split('.');
    let value = trans;
    for (const k of keys) {
      value = value[k];
      if (value === undefined) return key;
    }
    return value;
  }

  function getQuestionText(question, locale) {
    return locale === 'th' ? question.textTh : question.text;
  }

  function getAnswerText(answer, locale) {
    return locale === 'th' ? answer.textTh : answer.text;
  }

  function renderQuestion() {
    const question = questions[currentQuestionIndex];
    const qText = getQuestionText(question, locale);

    const answersHtml = question.answers.map((answer) => {
      const checked = answers[currentQuestionIndex] === answer.categoryId ? 'checked' : '';
      const ansText = getAnswerText(answer, locale);
      return `
        <label class="block cursor-pointer group">
          <input
            type="radio"
            name="question-${question.id}"
            value="${answer.categoryId}"
            class="hidden peer"
            ${checked}
          />
          <div class="p-5 border-2 border-gray-200 rounded-xl peer-checked:border-primary-600 peer-checked:bg-primary-50 hover:border-primary-300 transition-all cursor-pointer">
            <span class="text-gray-900 font-medium">${ansText}</span>
          </div>
        </label>
      `;
    }).join('');

    quizContainer.innerHTML = `
      <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-8">${qText}</h2>
      <div class="space-y-4">
        ${answersHtml}
      </div>
    `;

    const radios = quizContainer.querySelectorAll('input[type="radio"]');
    radios.forEach((radio) => {
      radio.addEventListener('change', (e) => {
        const target = e.target;
        answers[currentQuestionIndex] = parseInt(target.value);
        nextBtn.disabled = false;
      });
    });

    const progress = Math.round(((currentQuestionIndex + 1) / totalQuestions) * 100);
    progressBar.style.width = `${progress}%`;
    currentQuestionSpan.textContent = (currentQuestionIndex + 1).toString();
    progressPercent.textContent = `${progress}%`;

    backBtn.disabled = currentQuestionIndex === 0;
    nextBtn.disabled = answers[currentQuestionIndex] === null;
    const isLastQuestion = currentQuestionIndex === totalQuestions - 1;
    nextBtn.textContent = isLastQuestion ? getT('common.submit') : getT('quiz.next');
  }

  backBtn.addEventListener('click', () => {
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      renderQuestion();
    }
  });

  nextBtn.addEventListener('click', async () => {
    if (currentQuestionIndex < totalQuestions - 1) {
      currentQuestionIndex++;
      renderQuestion();
    } else {
      await submitQuiz();
    }
  });

  async function submitQuiz() {
    nextBtn.disabled = true;
    nextBtn.textContent = getT('quiz.submitting');

    try {
      const response = await fetch('/api/submit', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: userName,
          email: userEmail,
          answers: answers,
        }),
      });

      const data = await response.json();

      if (response.ok) {
        sessionStorage.clear();
        window.location.href = `/result/${data.accessToken}`;
      } else {
        alert(getT('quiz.submittingError') + data.error);
        nextBtn.disabled = false;
        nextBtn.textContent = getT('common.submit');
      }
    } catch (error) {
      console.error('Error:', error);
      alert(getT('quiz.errorOccurred'));
      nextBtn.disabled = false;
      nextBtn.textContent = getT('common.submit');
    }
  }

  renderQuestion();
</script>
