---
import Layout from '../layouts/Layout.astro';
import { getTranslations, type Locale } from '../lib/translations';

const locale = (Astro.cookies.get('locale')?.value || 'th') as 'th' | 'en';
const trans = getTranslations(locale);

function t(key: string): string {
  const keys = key.split('.');
  let value: any = trans;
  for (const k of keys) {
    value = value[k];
    if (value === undefined) return key;
  }
  return value as string;
}
---

<Layout title={`${t('onboarding.title')} - ${locale === 'th' ? 'แบบประเมินสไตล์การทำงาน' : 'Employee Style Assessment'}`}>
  <main class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 flex items-center justify-center px-4 py-12">
    <div class="max-w-md w-full">
      <!-- Card -->
      <div class="bg-white rounded-2xl shadow-xl p-8 md:p-10">
        <!-- Header -->
        <div class="text-center mb-8">
          <h1 class="text-3xl font-bold text-gray-900 mb-2">{t('onboarding.title')}</h1>
          <p class="text-gray-600">{t('onboarding.subtitle')}</p>
        </div>

        <!-- Form -->
        <form id="onboarding-form" class="space-y-6">
          <!-- Name Field -->
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
              {t('onboarding.fullName')}
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
              placeholder={t('onboarding.fullNamePlaceholder')}
            />
            <p id="name-error" class="hidden text-sm text-red-600 mt-1"></p>
          </div>

          <!-- Email Field -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
              {t('onboarding.emailAddress')}
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
              placeholder={t('onboarding.emailPlaceholder')}
            />
            <p id="email-error" class="hidden text-sm text-red-600 mt-1"></p>
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            class="w-full bg-primary-600 text-white py-4 rounded-lg font-semibold hover:bg-primary-700 transform hover:scale-[1.02] transition-all shadow-md hover:shadow-lg"
          >
            {t('onboarding.continueButton')}
          </button>
        </form>

        <!-- Privacy Note -->
        <p class="text-xs text-gray-500 text-center mt-6">
          {t('onboarding.privacyNote')}
        </p>
      </div>

      <!-- Back Link -->
      <div class="text-center mt-6">
        <a href="/" class="text-sm text-gray-600 hover:text-primary-600 transition-colors">
          {t('onboarding.backToHome')}
        </a>
      </div>
    </div>
  </main>
</Layout>

<script>
  import { z } from 'zod';

  const userSchema = z.object({
    name: z.string().min(2, 'Name must be at least 2 characters').max(100),
    email: z.string().email('Invalid email address'),
  });

  const form = document.getElementById('onboarding-form') as HTMLFormElement;
  const nameInput = document.getElementById('name') as HTMLInputElement;
  const emailInput = document.getElementById('email') as HTMLInputElement;
  const nameError = document.getElementById('name-error') as HTMLElement;
  const emailError = document.getElementById('email-error') as HTMLElement;

  form.addEventListener('submit', (e) => {
    e.preventDefault();

    // Clear previous errors
    nameError.classList.add('hidden');
    emailError.classList.add('hidden');
    nameInput.classList.remove('border-red-500');
    emailInput.classList.remove('border-red-500');

    const formData = {
      name: nameInput.value.trim(),
      email: emailInput.value.trim(),
    };

    try {
      userSchema.parse(formData);

      // Store in session storage
      sessionStorage.setItem('userName', formData.name);
      sessionStorage.setItem('userEmail', formData.email);

      // Navigate to quiz
      window.location.href = '/quiz';
    } catch (error) {
      if (error instanceof z.ZodError) {
        error.issues.forEach((err) => {
          if (err.path[0] === 'name') {
            nameError.textContent = err.message;
            nameError.classList.remove('hidden');
            nameInput.classList.add('border-red-500');
          } else if (err.path[0] === 'email') {
            emailError.textContent = err.message;
            emailError.classList.remove('hidden');
            emailInput.classList.add('border-red-500');
          }
        });
      }
    }
  });
</script>
